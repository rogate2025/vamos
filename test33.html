<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hybrid Chat System</title>
<style>
  body { font-family: Arial, sans-serif; text-align: center; margin: 20px; background: #f3f3f3; }
  #messages { height: 400px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px; background: #fff; margin-bottom: 20px; }
  input, button { padding: 10px; margin: 10px; width: 80%; }
  .message { padding: 10px; background: #e0e0e0; margin-bottom: 10px; border-radius: 5px; text-align: left; }
</style>
</head>
<body>
<h1>Hybrid Chat</h1>
<div id="messages"></div>
<input type="text" id="username" placeholder="Your Name">
<input type="text" id="message" placeholder="Type message...">
<button onclick="sendMessage()">Send</button>
<button onclick="clearMessages()">Clear</button>

<script>
  const messagesDiv = document.getElementById("messages");
  const messageInput = document.getElementById("message");
  const usernameInput = document.getElementById("username");
  const channel = new BroadcastChannel("chat");
  let ws;

  // WebSocket Connection (Online)
  function connectWebSocket() {
    ws = new WebSocket("wss://echo.websocket.org");
    ws.onopen = () => console.log("WebSocket Connected");
    ws.onmessage = (event) => receiveMessage(event.data);
    ws.onclose = () => console.warn("WebSocket Disconnected");
  }

  // Send Message
  function sendMessage() {
    const username = usernameInput.value.trim();
    const text = messageInput.value.trim();
    if (!username || !text) return;

    const message = `${username}: ${text}`;
    displayMessage(message);
    saveMessage(message);

    if (navigator.onLine) {
      ws.send(message); // Online
    } else {
      channel.postMessage(message); // Offline
    }
    messageInput.value = "";
  }

  // Receive Messages (Offline)
  channel.onmessage = (event) => receiveMessage(event.data);

  // Display Message
  function displayMessage(message) {
    const div = document.createElement("div");
    div.className = "message";
    div.textContent = message;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  // Save to LocalStorage
  function saveMessage(message) {
    let history = JSON.parse(localStorage.getItem("chat") || "[]");
    history.push(message);
    localStorage.setItem("chat", JSON.stringify(history));
  }

  // Load Messages on Page Load
  window.onload = () => {
    const history = JSON.parse(localStorage.getItem("chat") || "[]");
    history.forEach(displayMessage);
    if (navigator.onLine) {
      connectWebSocket();
    }
  };

  // Receive Messages
  function receiveMessage(message) {
    displayMessage(message);
    saveMessage(message);
  }

  // Clear Messages
  function clearMessages() {
    messagesDiv.innerHTML = "";
    localStorage.removeItem("chat");
  }
</script>
</body>
</html>
