<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Real-Time Chat</title>
<style>
  body { font-family: Arial, sans-serif; text-align: center; margin: 20px; background: #f3f3f3; }
  #messages { height: 400px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px; background: #fff; margin-bottom: 20px; }
  input, button { padding: 10px; margin: 10px; width: 80%; }
  .message { padding: 10px; background: #e0e0e0; margin-bottom: 10px; border-radius: 5px; text-align: left; }
</style>
</head>
<body>
<h1>Hybrid Chat Sync ðŸ”¥</h1>
<div id="messages"></div>
<input type="text" id="username" placeholder="Your Name">
<input type="text" id="message" placeholder="Type message...">
<button onclick="sendMessage()">Send</button>
<button onclick="clearMessages()">Clear</button>

<script>
  const messagesDiv = document.getElementById("messages");
  const messageInput = document.getElementById("message");
  const usernameInput = document.getElementById("username");
  const channel = new BroadcastChannel("offline_chat");
  let ws;

  // Initialize WebSocket if Online
  function connectWebSocket() {
    if (navigator.onLine) {
      ws = new WebSocket("wss://websocket-broadcast-server.glitch.me");

      ws.onopen = () => console.log("Connected to WebSocket");
      ws.onmessage = (event) => receiveMessage(event.data);
      ws.onerror = () => console.warn("WebSocket Error");
      ws.onclose = () => console.warn("WebSocket Disconnected");
    }
  }

  // Send Message
  function sendMessage() {
    const text = messageInput.value.trim();
    const username = usernameInput.value.trim();
    if (!text || !username) return;

    const message = `${username}: ${text}`;
    displayMessage(message);
    saveMessage(message);

    if (navigator.onLine && ws && ws.readyState === WebSocket.OPEN) {
      ws.send(message); // Online Sync
    } else {
      channel.postMessage(message); // Offline Sync
    }
    messageInput.value = "";
  }

  // Receive Messages
  channel.onmessage = (event) => {
    receiveMessage(event.data);
  };

  function receiveMessage(message) {
    displayMessage(message);
    saveMessage(message);
  }

  // Display Message
  function displayMessage(message) {
    const div = document.createElement("div");
    div.className = "message";
    div.textContent = message;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  // Save Messages to LocalStorage
  function saveMessage(message) {
    let history = JSON.parse(localStorage.getItem("chatHistory") || "[]");
    history.push(message);
    localStorage.setItem("chatHistory", JSON.stringify(history));
  }

  // Sync Old Messages
  window.onload = () => {
    const history = JSON.parse(localStorage.getItem("chatHistory") || "[]");
    history.forEach(displayMessage);
    connectWebSocket();
  };

  // Clear Messages
  function clearMessages() {
    messagesDiv.innerHTML = "";
    localStorage.removeItem("chatHistory");
  }
</script>
</body>
</html>
