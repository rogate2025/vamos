<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spin the Wheel Game</title>
    <style>
        body {
            margin: 0;
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #0a1a3d 0%, #1e3c72 50%, #000000 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: auto;
            color: #fff;
            position: relative;
        }

        .game-container {
            text-align: center;
            position: relative;
            padding: 20px;
        }

        h1 {
            font-size: 48px;
            text-shadow: 0 0 10px #ffd700;
            margin-bottom: 20px;
        }

        .wheel-container {
            width: 450px;
            height: 450px;
            margin: 0 auto;
            position: relative;
            border-radius: 50%;
            background: radial-gradient(circle, #ffd700 10%, transparent 60%);
        }

        canvas {
            width: 100%;
            height: 100%;
            border-radius: 50%;
        }

        .pointer {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-top: 40px solid #ffd700;
            z-index: 10;
            filter: drop-shadow(0 0 10px #ffd700);
        }

        #result, #guruji-result {
            font-size: 24px;
            font-weight: bold;
            color: #ffd700;
            margin-top: 20px;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            text-shadow: 0 0 10px #ffd700;
        }

        button {
            padding: 15px 30px;
            font-size: 18px;
            background: linear-gradient(45deg, #ffaa00, #ffd700);
            border: none;
            border-radius: 25px;
            color: #0a1a3d;
            cursor: pointer;
            margin-top: 20px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px #ffd700;
        }

        button:disabled {
            background: #666666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .guruji {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 200px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .guruji:hover {
            transform: scale(1.1);
        }

        #questionModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #1e3c72, #0a1a3d);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.7);
            z-index: 1000;
            width: 80%;
            max-width: 500px;
            text-align: center;
        }

        #questionModal.active {
            display: block;
        }

        #questionModal.glow {
            box-shadow: 0 0 30px #ffd700, 0 0 60px #ffaa00;
        }

        #closeModal {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            cursor: pointer;
            color: #ff6f61;
        }

        #questionContent {
            font-size: 20px;
            margin-bottom: 20px;
        }

        #timer {
            font-size: 18px;
            margin-bottom: 20px;
            opacity: 0;
            color: #ffd700;
            text-shadow: 0 0 10px #ffd700;
        }

        @keyframes pulseGlow {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .fireworks {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s;
            z-index: 999;
        }

        .particle {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            opacity: 0;
            animation: explode 1.5s ease-out forwards;
        }

        @keyframes explode {
            0% { transform: translate(0, 0); opacity: 1; }
            100% { transform: translate(var(--x), var(--y)); opacity: 0; }
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            opacity: 0;
            animation: fall 3s ease-out forwards;
            z-index: 1001;
        }

        @keyframes fall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        .balloon {
            position: fixed;
            width: 30px;
            height: 40px;
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            opacity: 0;
            animation: rise 4s ease-out forwards;
            z-index: 1001;
        }

        @keyframes rise {
            0% { transform: translateY(100vh); opacity: 1; }
            100% { transform: translateY(-100vh); opacity: 0; }
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-30px); }
            60% { transform: translateY(-15px); }
        }

        .bouncing-balloon {
            animation: bounce 2s infinite;
        }

        #congratsMessage {
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 20px 40px;
            border-radius: 15px;
            font-size: 24px;
            color: #ffd700;
            text-shadow: 0 0 10px #ffd700;
            opacity: 0;
            transition: opacity 0.5s;
            z-index: 1002;
            display: none;
        }

        .guruji-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #1e3c72, #0a1a3d);
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.7);
            z-index: 1000;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .guruji-content {
            position: relative;
        }

        .guruji-image {
            width: 100px;
            margin-bottom: 10px;
        }

        #guruji-intro {
            font-size: 16px;
            margin-bottom: 20px;
        }

        .guruji-content .wheel-container {
            width: 300px;
            height: 300px;
            margin: 20px auto;
            position: relative;
            border-radius: 50%;
            background: radial-gradient(circle, #ffd700 10%, transparent 60%);
        }

        .guruji-content canvas {
            width: 100%;
            height: 100%;
            border-radius: 50%;
        }

        .guruji-content .pointer {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 30px solid #ffd700;
            z-index: 10;
            filter: drop-shadow(0 0 10px #ffd700);
        }

        .guruji-content button {
            padding: 10px 20px;
            font-size: 16px;
            margin: 10px;
        }

        .guruji-close {
            background: #ff6f61;
            color: #fff;
        }

        #guruji-question-container {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 10px;
            position: relative;
            color: #fff;
        }

        #guruji-question-content {
            font-size: 18px;
            margin-bottom: 10px;
        }

        #guruji-timer {
            font-size: 16px;
            margin-bottom: 10px;
        }

        #closeGurujiQuestion {
            position: absolute;
            top: 5px;
            right: 5px;
            cursor: pointer;
            color: #ff6f61;
            font-size: 20px;
        }

        .glitter {
            position: absolute;
            width: 5px;
            height: 5px;
            background: rgba(255, 215, 0, 0.8);
            border-radius: 50%;
            pointer-events: none;
            animation: glitterFade 1s ease-out forwards;
        }

        @keyframes glitterFade {
            0% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(0); }
        }

        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 215, 0, 0.3);
            pointer-events: none;
            animation: ripple 1s ease-out forwards;
        }

        @keyframes ripple {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(4); opacity: 0; }
        }

        .snowflake, .leaf {
            position: fixed;
            font-size: 1.5em;
            opacity: 0.8;
            animation: fallAnimation 5s linear forwards;
        }

        @keyframes fallAnimation {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
        }

        .bubble {
            position: fixed;
            width: 20px;
            height: 20px;
            background: rgba(255, 215, 0, 0.5);
            border-radius: 50%;
            animation: bubblePop 2s ease-out forwards;
        }

        @keyframes bubblePop {
            0% { transform: translateY(100vh) scale(0.5); opacity: 1; }
            80% { transform: translateY(-20vh) scale(1); opacity: 1; }
            100% { transform: translateY(-30vh) scale(0); opacity: 0; }
        }

        .confetti-trail {
            position: absolute;
            width: 8px;
            height: 8px;
            background: hsl(var(--hue), 100%, 50%);
            animation: confettiTrail 1s ease-out forwards;
        }

        @keyframes confettiTrail {
            0% { opacity: 1; transform: translate(0, 0); }
            100% { opacity: 0; transform: translate(var(--x), var(--y)); }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <audio id="bgm" loop>
        <source src="bgm.mp3" type="audio/mpeg">
    </audio>
    <audio id="gurujiMusic" src="guruji.mp3"></audio>
    <audio id="spinMusic" src="spin.mp3"></audio>
    <audio id="celebrationMusic" src="celebration.mp3"></audio>

    <div class="game-container">
        <h1>Spin the Wheel</h1>
        <div class="wheel-container">
            <div class="pointer"></div>
            <canvas id="wheel" width="450" height="450"></canvas>
        </div>
        <div id="result"></div>
        <button id="spinBtn">Spin Now!</button>
        <img src="guruji.png" class="guruji" onclick="openGurujiPopup()">
    </div>

    <div id="questionModal">
        <div id="closeModal">❌</div>
        <div id="questionContent"></div>
        <div id="timer"></div>
        <button id="answerBtn">Show Answer</button>
        <button id="congratsBtn" style="display: none;">Congratulations!</button>
    </div>

    <div id="congratsMessage"></div>

    <div class="guruji-popup" id="guruji-popup">
        <div class="guruji-content">
            <img src="guruji.png" alt="Guruji" class="guruji-image">
            <p id="guruji-intro">Greetings, knowledge seekers! I am Guruji, your Quiz Master. Spin the wheel to get your challenge!</p>
            <div class="wheel-container">
                <div class="pointer"></div>
                <canvas id="guruji-wheel" width="300" height="300"></canvas>
            </div>
            <button id="guruji-spinBtn">Spin Now!</button>
            <div id="guruji-result"></div>
            <div id="guruji-question-container" style="display: none;">
                <div id="guruji-question-content"></div>
                <div id="guruji-timer"></div>
                <button id="guruji-answerBtn">Show Answer</button>
                <button id="guruji-congratsBtn" style="display: none;">Congratulations!</button>
                <div id="closeGurujiQuestion">❌</div>
            </div>
            <button class="guruji-close" onclick="closeGurujiPopup()">Close</button>
        </div>
    </div>

    <script>
        // Autoplay background music on first click
        document.addEventListener('click', function() {
            const audio = document.getElementById('bgm');
            if (audio.paused) {
                audio.play().catch(error => console.log("Background music play failed:", error));
            }
        }, { once: true });

        // Main Wheel Setup
        const canvas = document.getElementById('wheel');
        const ctx = canvas.getContext('2d');
        const spinBtn = document.getElementById('spinBtn');
        const resultDiv = document.getElementById('result');
        const fireworksDiv = document.createElement('div');
        fireworksDiv.className = 'fireworks';
        document.body.appendChild(fireworksDiv);
        const questionModal = document.getElementById('questionModal');
        const questionContent = document.getElementById('questionContent');
        const closeModal = document.getElementById('closeModal');
        const answerBtn = document.getElementById('answerBtn');
        const congratsBtn = document.getElementById('congratsBtn');
        const congratsMessage = document.getElementById('congratsMessage');
        const spinMusic = document.getElementById('spinMusic');
        const bgm = document.getElementById('bgm');
        const celebrationMusic = document.getElementById('celebrationMusic');
        let timerInterval;
        let gurujiTimerInterval;
        let mainCurrentQuestion = null;
        let gurujiCurrentQuestion = null;

        const questionSets = {
            "50": [
                { question: "What is the capital of France?", answer: "Paris" },
                { question: "Who wrote 'Romeo and Juliet'?", answer: "William Shakespeare" },
                { question: "What is the largest planet in our solar system?", answer: "Jupiter" }
            ],
            "100": [
                { question: "What is the smallest prime number?", answer: "2" },
                { question: "What is the square root of 64?", answer: "8" },
                { question: "What is the longest river in the world?", answer: "The Nile" }
            ],
            "150": [
                { question: "What is the capital of Japan?", answer: "Tokyo" },
                { question: "What is the largest ocean on Earth?", answer: "Pacific Ocean" },
                { question: "What is the chemical symbol for gold?", answer: "Au" }
            ],
            "200": [
                { question: "What is the capital of Australia?", answer: "Canberra" },
                { question: "What is the largest mammal on Earth?", answer: "Blue Whale" },
                { question: "What is the smallest country in the world?", answer: "Vatican City" }
            ],
            "250": [
                { question: "What is the capital of Brazil?", answer: "Brasília" },
                { question: "What is the largest desert in the world?", answer: "Sahara Desert" },
                { question: "What is the chemical symbol for oxygen?", answer: "O" }
            ],
            "300": [
                { question: "What is the capital of Canada?", answer: "Ottawa" },
                { question: "What is the largest island in the world?", answer: "Greenland" },
                { question: "What is the chemical symbol for carbon?", answer: "C" }
            ],
            "350": [
                { question: "What is the capital of Russia?", answer: "Moscow" },
                { question: "What is the largest continent on Earth?", answer: "Asia" },
                { question: "What is the chemical symbol for silver?", answer: "Ag" }
            ],
            "400": [
                { question: "What is the capital of China?", answer: "Beijing" },
                { question: "What is the largest moon in the solar system?", answer: "Ganymede" },
                { question: "What is the chemical symbol for iron?", answer: "Fe" }
            ]
        };

        const gurujiQuestions = [
            { question: "What is the capital of Italy?", answer: "Rome" },
            { question: "Who wrote 'Hamlet'?", answer: "William Shakespeare" },
            { question: "What is the largest mammal on Earth?", answer: "Blue Whale" },
            { question: "What is the chemical symbol for water?", answer: "H2O" },
            { question: "Who painted the Sistine Chapel ceiling?", answer: "Michelangelo" },
            { question: "Which planet is closest to the Sun?", answer: "Mercury" },
            { question: "What is the tallest mountain in the world?", answer: "Mount Everest" }
        ];

        const segments = [
            { number: "50", visible: true },
            { number: "100", visible: true },
            { number: "150", visible: true },
            { number: "200", visible: true },
            { number: "250", visible: true },
            { number: "300", visible: true },
            { number: "350", visible: true },
            { number: "400", visible: true }
        ];

        const usedQuestions = {
            "50": [], "100": [], "150": [], "200": [],
            "250": [], "300": [], "350": [], "400": []
        };

        const colors = ['#ff6f61', '#6b5b95', '#88b04b', '#f7cac9', '#92a8d1', '#f9cb9c', '#b565a7', '#009b77'];
        const radius = canvas.width / 2;
        const arc = 2 * Math.PI / segments.length;
        const pointerAngle = 3 * Math.PI / 2;
        let currentAngle = 0;
        let isSpinning = false;
        let lastLandedNumber = null;

        const motivationalQuotes = [
            "Great job! The only way to do great work is to love what you do.",
            "Well done! Success is the sum of small efforts repeated day in and day out.",
            "Fantastic! Believe you can and you're halfway there."
        ];

        // Guruji Wheel Setup
        const gurujiCanvas = document.getElementById('guruji-wheel');
        const gurujiCtx = gurujiCanvas.getContext('2d');
        const gurujiRadius = gurujiCanvas.width / 2;
        const gurujiArc = 2 * Math.PI / gurujiQuestions.length;
        let gurujiCurrentAngle = 0;
        let gurujiIsSpinning = false;
        let gurujiLastLandedSegment = null;

        const gurujiSegments = gurujiQuestions.map((q, index) => ({
            number: (index + 1).toString(),
            visible: true,
            question: q
        }));

        // Utility Functions
        function normalizeAngle(angle) {
            angle = angle % (2 * Math.PI);
            if (angle < 0) angle += 2 * Math.PI;
            return angle;
        }

        // Main Wheel Functions
        function drawWheel() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            segments.forEach((segment, i) => {
                const angle = currentAngle + (i * arc);
                ctx.beginPath();
                ctx.fillStyle = segment.visible ? colors[i] : '#333333';
                ctx.moveTo(radius, radius);
                ctx.arc(radius, radius, radius, angle, angle + arc);
                ctx.lineTo(radius, radius);
                ctx.fill();

                ctx.save();
                ctx.translate(radius, radius);
                ctx.rotate(angle + arc / 2);
                ctx.fillStyle = segment.visible ? '#0a1a3d' : '#666666';
                ctx.font = 'bold 24px Poppins';
                ctx.textAlign = 'right';
                ctx.fillText(segment.number, radius - 30, 10);
                ctx.restore();

                if (!segment.visible) {
                    ctx.beginPath();
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                    ctx.moveTo(radius, radius);
                    ctx.arc(radius, radius, radius, angle, angle + arc);
                    ctx.lineTo(radius, radius);
                    ctx.fill();
                }
            });
        }

        function getSegmentAtAngle(angle) {
            const visibleSegments = segments.filter(s => s.visible);
            if (visibleSegments.length === 0) return null;
            const relativeAngle = normalizeAngle(angle - currentAngle);
            const segmentIndex = Math.floor(relativeAngle / arc) % visibleSegments.length;
            return visibleSegments[segmentIndex];
        }

        function handleWheelClick(event) {
            if (isSpinning || !lastLandedNumber) return;

            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            const dx = x - radius;
            const dy = y - radius;
            const dist = Math.sqrt(dx * dx + dy * dy);
            if (dist > radius) return;

            const clickAngle = Math.atan2(dy, dx);
            const clickedSegment = getSegmentAtAngle(clickAngle);
            if (clickedSegment && clickedSegment.number === lastLandedNumber) {
                mainCurrentQuestion = getRandomQuestion(lastLandedNumber);
                if (mainCurrentQuestion) {
                    showQuestionModal(mainCurrentQuestion.question);
                } else {
                    resultDiv.textContent = `Section ${lastLandedNumber} questions exhausted!`;
                    resultDiv.style.opacity = '1';
                }
            } else {
                alert(`Please click on the landed sector: ${lastLandedNumber}`);
            }
        }

        function getRandomQuestion(setNumber) {
            const availableQuestions = questionSets[setNumber].filter(q => !usedQuestions[setNumber].includes(q));
            if (availableQuestions.length === 0) {
                const segment = segments.find(s => s.number === setNumber);
                segment.visible = false;
                drawWheel();
                return null;
            }
            const question = availableQuestions[Math.floor(Math.random() * availableQuestions.length)];
            usedQuestions[setNumber].push(question);
            if (availableQuestions.length === 1) {
                const segment = segments.find(s => s.number === setNumber);
                segment.visible = false;
                drawWheel();
            }
            return question;
        }

        function spinWheel() {
            if (isSpinning) return;

            const visibleSegments = segments.filter(s => s.visible);
            if (visibleSegments.length === 0) {
                resultDiv.textContent = "All questions exhausted!";
                resultDiv.style.opacity = '1';
                spinBtn.disabled = true;
                return;
            }

            isSpinning = true;
            spinBtn.disabled = true;
            resultDiv.style.opacity = '0';

            bgm.pause();
            spinMusic.play().catch(error => console.log("Spin music play failed:", error));

            const spins = 5 + Math.floor(Math.random() * 5);
            const randomSegmentIndex = Math.floor(Math.random() * visibleSegments.length);
            const segmentCenter = segments.indexOf(visibleSegments[randomSegmentIndex]) * arc + arc / 2;
            const delta = normalizeAngle(pointerAngle - segmentCenter);
            const targetAngle = delta + 2 * Math.PI * spins;

            let startTime;
            const duration = 5000;

            function animate(timestamp) {
                if (!startTime) startTime = timestamp;
                const elapsed = timestamp - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easeProgress = 1 - Math.pow(1 - progress, 4);
                currentAngle = easeProgress * targetAngle;
                drawWheel();
                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    currentAngle = targetAngle;
                    drawWheel();
                    const selected = getSegmentAtAngle(pointerAngle);
                    lastLandedNumber = selected.number;
                    resultDiv.textContent = `You landed on: ${selected.number}`;
                    resultDiv.style.opacity = '1';
                    createFireworks();
                    isSpinning = false;
                    spinBtn.disabled = false;
                    spinMusic.pause();
                    spinMusic.currentTime = 0;
                    bgm.play().catch(error => console.log("Background music resume failed:", error));
                }
            }
            requestAnimationFrame(animate);
        }

        // Guruji Wheel Functions
        function drawGurujiWheel() {
            gurujiCtx.clearRect(0, 0, gurujiCanvas.width, gurujiCanvas.height);
            gurujiSegments.forEach((segment, i) => {
                const angle = gurujiCurrentAngle + (i * gurujiArc);
                gurujiCtx.beginPath();
                gurujiCtx.fillStyle = segment.visible ? colors[i % colors.length] : '#333333';
                gurujiCtx.moveTo(gurujiRadius, gurujiRadius);
                gurujiCtx.arc(gurujiRadius, gurujiRadius, gurujiRadius, angle, angle + gurujiArc);
                gurujiCtx.lineTo(gurujiRadius, gurujiRadius);
                gurujiCtx.fill();

                gurujiCtx.save();
                gurujiCtx.translate(gurujiRadius, gurujiRadius);
                gurujiCtx.rotate(angle + gurujiArc / 2);
                gurujiCtx.fillStyle = segment.visible ? '#0a1a3d' : '#666666';
                gurujiCtx.font = 'bold 18px Poppins';
                gurujiCtx.textAlign = 'right';
                gurujiCtx.fillText(segment.number, gurujiRadius - 20, 5);
                gurujiCtx.restore();

                if (!segment.visible) {
                    gurujiCtx.beginPath();
                    gurujiCtx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                    gurujiCtx.moveTo(gurujiRadius, gurujiRadius);
                    gurujiCtx.arc(gurujiRadius, gurujiRadius, gurujiRadius, angle, angle + gurujiArc);
                    gurujiCtx.lineTo(gurujiRadius, gurujiRadius);
                    gurujiCtx.fill();
                }
            });
        }

        function getGurujiSegmentAtAngle(angle) {
            const visibleSegments = gurujiSegments.filter(s => s.visible);
            if (visibleSegments.length === 0) return null;
            const relativeAngle = normalizeAngle(angle - gurujiCurrentAngle);
            const segmentIndex = Math.floor(relativeAngle / gurujiArc) % visibleSegments.length;
            return visibleSegments[segmentIndex];
        }

        function spinGurujiWheel() {
            if (gurujiIsSpinning) return;

            const visibleSegments = gurujiSegments.filter(s => s.visible);
            if (visibleSegments.length === 0) {
                document.getElementById('guruji-result').textContent = "All questions exhausted!";
                document.getElementById('guruji-result').style.opacity = '1';
                document.getElementById('guruji-spinBtn').disabled = true;
                return;
            }

            gurujiIsSpinning = true;
            document.getElementById('guruji-spinBtn').disabled = true;
            document.getElementById('guruji-result').style.opacity = '0';

            bgm.pause();
            spinMusic.play().catch(error => console.log("Spin music play failed:", error));

            const spins = 5 + Math.floor(Math.random() * 5);
            const randomSegmentIndex = Math.floor(Math.random() * visibleSegments.length);
            const segmentCenter = gurujiSegments.indexOf(visibleSegments[randomSegmentIndex]) * gurujiArc + gurujiArc / 2;
            const delta = normalizeAngle(pointerAngle - segmentCenter);
            const targetAngle = delta + 2 * Math.PI * spins;

            let startTime;
            const duration = 5000;

            function animate(timestamp) {
                if (!startTime) startTime = timestamp;
                const elapsed = timestamp - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easeProgress = 1 - Math.pow(1 - progress, 4);
                gurujiCurrentAngle = easeProgress * targetAngle;
                drawGurujiWheel();
                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    gurujiCurrentAngle = targetAngle;
                    drawGurujiWheel();
                    const selected = getGurujiSegmentAtAngle(pointerAngle);
                    gurujiLastLandedSegment = selected;
                    document.getElementById('guruji-result').textContent = `You landed on: ${selected.number}`;
                    document.getElementById('guruji-result').style.opacity = '1';
                    createFireworks();
                    gurujiIsSpinning = false;
                    document.getElementById('guruji-spinBtn').disabled = false;
                    spinMusic.pause();
                    spinMusic.currentTime = 0;
                    bgm.play().catch(error => console.log("Background music resume failed:", error));
                }
            }
            requestAnimationFrame(animate);
        }

        function handleGurujiWheelClick(event) {
            if (gurujiIsSpinning || !gurujiLastLandedSegment) return;

            const rect = gurujiCanvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            const dx = x - gurujiRadius;
            const dy = y - gurujiRadius;
            const dist = Math.sqrt(dx * dx + dy * dy);
            if (dist > gurujiRadius) return;

            const clickAngle = Math.atan2(dy, dx);
            const clickedSegment = getGurujiSegmentAtAngle(clickAngle);
            if (clickedSegment && clickedSegment.number === gurujiLastLandedSegment.number) {
                if (clickedSegment.visible) {
                    gurujiCurrentQuestion = clickedSegment.question;
                    showGurujiQuestionInPopup(gurujiCurrentQuestion.question);
                    clickedSegment.visible = false;
                    drawGurujiWheel();
                } else {
                    document.getElementById('guruji-result').textContent = "Question already answered!";
                    document.getElementById('guruji-result').style.opacity = '1';
                }
            } else {
                alert(`Please click on the landed sector: ${gurujiLastLandedSegment.number}`);
            }
        }

        function openGurujiPopup() {
            const popup = document.getElementById("guruji-popup");
            popup.style.display = "flex";
            drawGurujiWheel();
            playSound("gurujiMusic");
        }

        function closeGurujiPopup() {
            document.getElementById("guruji-popup").style.display = "none";
            stopSound("gurujiMusic");
            document.getElementById('guruji-question-container').style.display = 'none';
            clearInterval(gurujiTimerInterval);
        }

        // Shared Functions
        function showQuestionModal(question) {
            questionContent.textContent = `Question: ${question}`;
            questionModal.classList.add('active');
            answerBtn.style.display = 'block';
            congratsBtn.style.display = 'none';

            let timeLeft = 60;
            const timerDisplay = document.getElementById('timer');
            timerDisplay.textContent = `Time Left: ${timeLeft}s`;
            timerDisplay.style.opacity = '1';
            timerDisplay.style.animation = 'pulseGlow 1s infinite';
            timerDisplay.style.color = '#ffd700';

            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = `Time Left: ${timeLeft}s`;

                if (timeLeft <= 10) {
                    timerDisplay.style.color = '#ff6f61';
                    timerDisplay.style.animation = 'pulseGlow 0.5s infinite';
                }

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    questionContent.textContent = "Time's up!";
                    answerBtn.style.display = 'none';
                    timerDisplay.style.opacity = '0';
                    timerDisplay.style.animation = 'none';
                }
            }, 1000);

            answerBtn.onclick = () => {
                if (mainCurrentQuestion) {
                    clearInterval(timerInterval);
                    questionContent.textContent = `Answer: ${mainCurrentQuestion.answer}`;
                    answerBtn.style.display = 'none';
                    congratsBtn.style.display = 'block';
                    timerDisplay.style.opacity = '0';
                    timerDisplay.style.animation = 'none';
                }
            };
        }

        function showGurujiQuestionInPopup(question) {
            const container = document.getElementById('guruji-question-container');
            const content = document.getElementById('guruji-question-content');
            const timerDisplay = document.getElementById('guruji-timer');
            const answerBtn = document.getElementById('guruji-answerBtn');
            const congratsBtn = document.getElementById('guruji-congratsBtn');
            const closeBtn = document.getElementById('closeGurujiQuestion');

            content.textContent = `Question: ${question}`;
            container.style.display = 'block';
            answerBtn.style.display = 'block';
            congratsBtn.style.display = 'none';

            let timeLeft = 60;
            timerDisplay.textContent = `Time Left: ${timeLeft}s`;
            timerDisplay.style.opacity = '1';
            timerDisplay.style.color = '#ffd700';

            clearInterval(gurujiTimerInterval);
            gurujiTimerInterval = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = `Time Left: ${timeLeft}s`;

                if (timeLeft <= 10) {
                    timerDisplay.style.color = '#ff6f61';
                }

                if (timeLeft <= 0) {
                    clearInterval(gurujiTimerInterval);
                    content.textContent = "Time's up!";
                    answerBtn.style.display = 'none';
                    timerDisplay.style.opacity = '0';
                }
            }, 1000);

            answerBtn.onclick = () => {
                if (gurujiCurrentQuestion) {
                    clearInterval(gurujiTimerInterval);
                    content.textContent = `Answer: ${gurujiCurrentQuestion.answer}`;
                    answerBtn.style.display = 'none';
                    congratsBtn.style.display = 'block';
                    timerDisplay.style.opacity = '0';
                }
            };

            congratsBtn.onclick = () => {
                triggerCelebration();
            };

            closeBtn.onclick = () => {
                container.style.display = 'none';
                clearInterval(gurujiTimerInterval);
            };
        }

        function hideQuestionModal() {
            questionModal.classList.remove('active');
            questionModal.classList.remove('glow');
            answerBtn.style.display = 'none';
            congratsBtn.style.display = 'none';
            clearInterval(timerInterval);
            const timerDisplay = document.getElementById('timer');
            timerDisplay.style.opacity = '0';
            timerDisplay.style.animation = 'none';
            document.body.style.background = 'linear-gradient(135deg, #0a1a3d 0%, #1e3c72 50%, #000000 100%)';
            congratsMessage.style.opacity = '0';
            congratsMessage.style.display = 'none';
            document.querySelectorAll('.confetti, .balloon, .glitter, .ripple, .snowflake, .leaf, .bubble, .confetti-trail').forEach(el => el.remove());
            fireworksDiv.style.opacity = '0';
        }

        function createFireworks() {
            fireworksDiv.innerHTML = '';
            const particleCount = 30;
            const particleColors = ['#ffd700', '#ffaa00', '#ff6f61', '#6b5b95', '#88b04b'];
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                const angle = Math.random() * 2 * Math.PI;
                const distance = Math.random() * 120 + 60;
                const x = Math.cos(angle) * distance;
                const y = Math.sin(angle) * distance;
                particle.style.background = particleColors[Math.floor(Math.random() * particleColors.length)];
                particle.style.setProperty('--x', `${x}px`);
                particle.style.setProperty('--y', `${y}px`);
                fireworksDiv.appendChild(particle);
            }
            fireworksDiv.style.opacity = '1';
            setTimeout(() => fireworksDiv.style.opacity = '0', 1200);
        }

        function triggerCelebration() {
            const effects = [
                () => {
                    for (let i = 0; i < 50; i++) {
                        const confetti = document.createElement('div');
                        confetti.className = 'confetti';
                        confetti.style.left = `${Math.random() * 100}vw`;
                        confetti.style.background = `hsl(${Math.random() * 360}, 100%, 50%)`;
                        confetti.style.animationDelay = `${Math.random() * 0.5}s`;
                        document.body.appendChild(confetti);
                        setTimeout(() => {
                            confetti.style.opacity = '1';
                            setTimeout(() => {
                                confetti.style.opacity = '0';
                                setTimeout(() => confetti.remove(), 300);
                            }, 2700);
                        }, 10);
                    }
                },
                () => {
                    createFireworks();
                },
                () => {
                    document.addEventListener('mousemove', createGlitterTrail);
                    setTimeout(() => {
                        document.removeEventListener('mousemove', createGlitterTrail);
                    }, 3000);
                },
                () => {
                    document.addEventListener('click', createRipple);
                    setTimeout(() => {
                        document.removeEventListener('click', createRipple);
                    }, 3000);
                },
                () => {
                    for (let i = 0; i < 30; i++) {
                        const isSnow = Math.random() > 0.5;
                        const element = document.createElement('div');
                        element.className = isSnow ? 'snowflake' : 'leaf';
                        element.textContent = isSnow ? '❄️' : '🍂';
                        element.style.left = `${Math.random() * 100}vw`;
                        element.style.animationDelay = `${Math.random() * 2}s`;
                        document.body.appendChild(element);
                        setTimeout(() => element.remove(), 5000);
                    }
                },
                () => {
                    document.body.style.background = 'linear-gradient(135deg, red, orange, yellow, green, blue, indigo, violet)';
                    setTimeout(() => {
                        document.body.style.background = 'linear-gradient(135deg, #0a1a3d 0%, #1e3c72 50%, #000000 100%)';
                    }, 2000);
                },
                () => {
                    for (let i = 0; i < 10; i++) {
                        const balloon = document.createElement('div');
                        balloon.className = 'balloon bouncing-balloon';
                        balloon.style.left = `${Math.random() * 100}vw`;
                        balloon.style.background = `hsl(${Math.random() * 360}, 80%, 60%)`;
                        balloon.style.animationDelay = `${Math.random() * 0.5}s`;
                        document.body.appendChild(balloon);
                        setTimeout(() => {
                            balloon.style.opacity = '1';
                            setTimeout(() => {
                                balloon.style.opacity = '0';
                                setTimeout(() => balloon.remove(), 300);
                            }, 3700);
                        }, 10);
                    }
                },
                () => {
                    for (let i = 0; i < 20; i++) {
                        const bubble = document.createElement('div');
                        bubble.className = 'bubble';
                        bubble.style.left = `${Math.random() * 100}vw`;
                        bubble.style.animationDelay = `${Math.random() * 1}s`;
                        document.body.appendChild(bubble);
                        setTimeout(() => bubble.remove(), 2000);
                    }
                },
                () => {
                    const emojis = ['😂', '🔥', '🎉', '🎊', '💥'];
                    for (let i = 0; i < 20; i++) {
                        const emoji = document.createElement('div');
                        emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                        emoji.style.position = 'fixed';
                        emoji.style.left = `${Math.random() * 100}vw`;
                        emoji.style.top = `${Math.random() * 100}vh`;
                        emoji.style.fontSize = '2em';
                        emoji.style.opacity = '1';
                        emoji.style.transition = 'opacity 1s';
                        document.body.appendChild(emoji);
                        setTimeout(() => {
                            emoji.style.opacity = '0';
                            setTimeout(() => emoji.remove(), 1000);
                        }, 1000);
                    }
                },
                () => {
                    document.addEventListener('mousemove', createConfettiTrail);
                    setTimeout(() => {
                        document.removeEventListener('mousemove', createConfettiTrail);
                    }, 3000);
                },
                () => {
                    const isLightMode = Math.random() > 0.5;
                    document.body.style.background = isLightMode ? '#ffffff' : '#000000';
                    fireworksDiv.innerHTML = '';
                    const particleCount = 30;
                    const particleColors = isLightMode ? ['#ff0000', '#00ff00', '#0000ff'] : ['#ffd700', '#ffaa00', '#ff6f61'];
                    for (let i = 0; i < particleCount; i++) {
                        const particle = document.createElement('div');
                        particle.className = 'particle';
                        const angle = Math.random() * 2 * Math.PI;
                        const distance = Math.random() * 120 + 60;
                        const x = Math.cos(angle) * distance;
                        const y = Math.sin(angle) * distance;
                        particle.style.background = particleColors[Math.floor(Math.random() * particleColors.length)];
                        particle.style.setProperty('--x', `${x}px`);
                        particle.style.setProperty('--y', `${y}px`);
                        fireworksDiv.appendChild(particle);
                    }
                    fireworksDiv.style.opacity = '1';
                    setTimeout(() => {
                        fireworksDiv.style.opacity = '0';
                        document.body.style.background = 'linear-gradient(135deg, #0a1a3d 0%, #1e3c72 50%, #000000 100%)';
                    }, 1500);
                }
            ];

            const randomEffect = effects[Math.floor(Math.random() * effects.length)];
            randomEffect();
            celebrationMusic.play().catch(error => console.log("Celebration music failed:", error));
            setTimeout(() => {
                celebrationMusic.pause();
                celebrationMusic.currentTime = 0;
            }, 3000);
        }

        function createGlitterTrail(e) {
            const glitter = document.createElement('div');
            glitter.className = 'glitter';
            glitter.style.left = `${e.pageX}px`;
            glitter.style.top = `${e.pageY}px`;
            document.body.appendChild(glitter);
            setTimeout(() => glitter.remove(), 1000);
        }

        function createRipple(e) {
            const ripple = document.createElement('div');
            ripple.className = 'ripple';
            ripple.style.left = `${e.pageX - 50}px`;
            ripple.style.top = `${e.pageY - 50}px`;
            ripple.style.width = '100px';
            ripple.style.height = '100px';
            document.body.appendChild(ripple);
            setTimeout(() => ripple.remove(), 1000);
        }

        function createConfettiTrail(e) {
            const confetti = document.createElement('div');
            confetti.className = 'confetti-trail';
            confetti.style.left = `${e.pageX}px`;
            confetti.style.top = `${e.pageY}px`;
            confetti.style.setProperty('--hue', Math.random() * 360);
            const angle = Math.random() * 2 * Math.PI;
            const distance = Math.random() * 50 + 20;
            const x = Math.cos(angle) * distance;
            const y = Math.sin(angle) * distance;
            confetti.style.setProperty('--x', `${x}px`);
            confetti.style.setProperty('--y', `${y}px`);
            document.body.appendChild(confetti);
            setTimeout(() => confetti.remove(), 1000);
        }

        function playSound(id) {
            document.getElementById(id).play().catch(error => console.log(`Sound ${id} play failed:`, error));
        }

        function stopSound(id) {
            const sound = document.getElementById(id);
            sound.pause();
            sound.currentTime = 0;
        }

        // Event Listeners
        canvas.addEventListener('click', handleWheelClick);
        spinBtn.addEventListener('click', spinWheel);
        closeModal.addEventListener('click', hideQuestionModal);
        congratsBtn.addEventListener('click', () => {
            triggerCelebration();
        });

        // Guruji Event Listeners
        document.getElementById('guruji-spinBtn').addEventListener('click', spinGurujiWheel);
        gurujiCanvas.addEventListener('click', handleGurujiWheelClick);

        // Initialize
        drawWheel();
    </script>
</body>
</html>